---
layout:         post
title:          gitlab 高可用
subtitle:       gitlab 高可用
date:           2020-06-24 11:53:00
author:         nomadli
header-img:     ../img/bg-coffee.jpeg
catalog:        true
tags:
        - other
---

* content
{:toc}

## 备份模式
- [原始文档](https://docs.gitlab.com/ce/raketasks/backup_restore.html#configuring-cron-to-make-daily-backups)
- 2k用户时单机足够, 只需冷备
- 备份文件的权限 /etc/gitlab/gitlab.rb gitlab_rails['backup_archive_permissions'] = 0644
- 备份保留时长秒 gitlab_rails['backup_keep_time'] = 604800
- 备份路径config/gitlab.yml backup_path 指定目录 EPOCH_YYYY_MM_DD_GitLab_version_gitlab_backup.tar
- 备份数据包括:数据库(db)、附件(uploads)、Git(repositories)、CI/CD日志(builds)、CI/CD输出包(artifacts)、LFS对象(lfs)、容器注册表图像(registry)、GitLab页面内容(pages)
- 不备份数据 配置信息文件
    ```text
    install use Omnibus:
    /etc/gitlab/gitlab-secrets.json
    /etc/gitlab/gitlab.rb
    install use source
    /home/git/gitlab/config/secrets.yml
    /home/git/gitlab/config/gitlab.yml
    install use docker
    mont disk /srv/gitlab/config
    ```
- 还原需要保证另一台机器安装了相同版本的gitlab,目录结构相同,先restore再还原备份的配置
- 备份步骤
    ```shell
    yum install rsync

    install with Omnibus
    sudo gitlab-backup create 早期版本 gitlab-rake gitlab:backup:create
    install use source
    sudo -u git -H bundle exec rake gitlab:backup:create RAILS_ENV=production
    install use docker
    docker exec -t <container name> gitlab-backup create
    install use k8
    kubectl exec -it <gitlab task-runner pod> backup-utility

    sudo gitlab-backup create STRATEGY=copy copy参数防止在备份时数据被修改导致的压缩失败
    gitlab-rake gitlab:backup:creat 早期版本

    sudo gitlab-backup create SKIP=db,uploads,repositories,builds,artifacts,lfs,registry,pages 排除备份项
    sudo -u git -H bundle exec rake gitlab:backup:create SKIP=db,uploads RAILS_ENV=production

    sudo gitlab-backup create SKIP=tar 禁用压缩, 直接保存中间文件夹,但下次备份会覆盖
    sudo -u git -H bundle exec rake gitlab:backup:create SKIP=tar RAILS_ENV=production

    sudo gitlab-backup create DIRECTORY=daily 指定目录
    ```
- 还原步骤
    ```shell
    install with Omnibus
    sudo gitlab-ctl reconfigure 至少执行过一次
    sudo gitlab-ctl start 如果没有启动
    cp xxx.tar gitlab.rb->gitlab_rails['backup_path']
    sudo chown git.git gitlab.rb->gitlab_rails['backup_path']/xxx.tar
    sudo gitlab-ctl stop unicorn
    sudo gitlab-ctl stop puma
    sudo gitlab-ctl stop sidekiq
    sudo gitlab-ctl status
    sudo gitlab-backup restore BACKUP=xxx
    gitlab-rake gitlab:backup:restore 早期版本
    还原配置
    sudo gitlab-ctl reconfigure
    sudo gitlab-ctl restart
    sudo gitlab-rake gitlab:check SANITIZE=true

    install from source
    sudo service gitlab stop
    bundle exec rake gitlab:backup:restore RAILS_ENV=production
    还原配置
    sudo service gitlab restart
    ```

## 集群模式
- nginx + gitlab站点 + redis集群 + PostgreSQL集群 + Gitaly集群
- PostgreSQL
    - [集群](https://www.cnblogs.com/lottu/p/5646486.html)
    - [复制](https://www.cnblogs.com/lottu/p/7490733.html)
    - [gitlab 数据库配置](https://docs.gitlab.com/ee/install/installation.html#6-database)
    ```shell
    install postgresql postgresql-client libpq-dev postgresql-contrib
    service postgresql start
    service postgresql status
    sudo -u postgres psql -d template1 -c "CREATE USER git CREATEDB encrypted password 'pass';" 创建并配置gitlab使用的用户
    sudo -u postgres psql -d template1 -c "CREATE EXTENSION IF NOT EXISTS pg_trgm;" 启用扩展
    /etc/gitlab/gitlab.rb   postgresql['enable'] = false 禁用本地用户
    /etc/gitlab/gitlab.rb   gitlab_rails['db_adapter'] = 'postgresql'
    /etc/gitlab/gitlab.rb   gitlab_rails['db_encoding'] = 'utf8'
    /etc/gitlab/gitlab.rb   gitlab_rails['db_host'] = 'ip'
    /etc/gitlab/gitlab.rb   gitlab_rails['db_port'] = "5432"
    #/etc/gitlab/gitlab.rb   gitlab_rails['db_pool'] = 30
    #/etc/gitlab/gitlab.rb   gitlab_rails['db_database'] = "gitlabhq_production"
    /etc/gitlab/gitlab.rb   gitlab_rails['db_username'] = "git"
    /etc/gitlab/gitlab.rb   gitlab_rails['db_password'] = 'DB password'
    sudo gitlab-ctl reconfigure
    ```
- [Gitaly](https://docs.gitlab.com/ee/administration/gitaly/praefect.html)
- [负载均衡db-ce方案](https://docs.gitlab.com/ce/administration/database_load_balancing.html)
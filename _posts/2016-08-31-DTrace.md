---
layout: post
title:  "DTrace"
date:   2016-08-31 11:34:00
categories: Other
excerpt: DTrace。
---

* content
{:toc}

## pragma
01. pragma D 指定特定的编译指令
02. pragma D aggrate 聚合读取的频率
03. pragma D aggsize 聚合缓冲区的大小
04. pragma D bufresize 缓冲区调整大小的策略 auto manual
05. pragma D bufsize -b 主缓冲区大小
06. pragma D cleanrate 清除频率
07. pragma D cpu -c 指定cpu
08. pragma D defaultargs 允许引用未指定的宏参数
09. pragma D destructive -w 允许破坏性操作
10. pragma D dynvarsize 动态变量空间大小
11. pragma D flowindent -F 入函数缩进显示加前缀->,退出函数取消缩进，并加前缀<-
12. pragma D grabanon -a 声明匿名跟踪状态
13. pragma D jstackframe 缺省的jstack()栈帧的数量
14. pragma D jstackstrsize jstack()缺省字符串大小
15. pragma D nspec 推理缓冲区的个数
16. pragma D quiet -q 仅输出显示跟踪的数据（比如printf）
17. pragma D specsize 推理缓冲区的大小
18. pragma D strsize 字符串大小
19. pragma D stackframes 栈帧数
20. pragma D stackindent 当缩进stack()和ustack()是的空
21. pragma D statusrate 时间 状态检查的频率
22. pragma D switchrate 时间 缓冲区切换的频率
23. pragma D ustackframes 用户栈帧数
24. pragma D depends_on library 相当于include

## 时间
01. walltimestamp 相对于Unix epoch纳秒数
02. vtimestamp 当前线程在CPU上运行的时间减去在DTrace上消耗的时间
03. machtimestamp 对应mach_absolute_time()

## 语句
01. 探针描述 provider:module:function:name 每个部分都可以省略或通配符,必须有
02. 断言 即条件 /条件/ 可选
03. 动作 顺序执行 无循环和分支 {动作} 可选

## 探针描述
01. dtrace:::BEGIN 脚本开始时执行
02. dtrace:::END 脚本退出时执行
03. dtrace:::ERROR 脚本错误时执行 
04. sudo dtrace -l | awk '{ match($2, "([a-z,A-Z]*)");print substr($2, RSTART, RLENGTH); }' | sort -u 列出所有可用探针
05. tick-10sec 每10秒执行 在一个cpu上触发
06. profile-1001 每1001赫兹执行 在所有cpu上触发
07. pid123:libSystem:printf:return pid为123的print函数
08. objc123:NSTableView:draw?:entry pid为123obj类函数
09. io::: start done wait-start wait-done journal-start journal-done
10. ip:::send ip:::receive arg0-arg5
11. 自定义静态探针 provider name{probe name(param)} name.d dtrace -h -s name.d 
12. 多个探针可以用','进行分隔
13. :entry :return 函数进入和退出

## 断言
01. 条件可使用 && || / a == b && c == d /

## 语句
01. sum(...) 集积函数 对key对应的值累加
02. count() 集积函数 对key对应的函数调用次数
03. avg(...) 集积函数 对key对应的值平均值
04. min(...) 集积函数 对key对应的值最小
05. max(...) 集积函数 对key对应的值最大
06. lquantize()  集积函数
07. quantize()  集积函数
08. trunc(@name, number)集积函数 排序并取前number个
09. printa(...) 打印
10. clear(@name) 清除
11. normalize(@name, .)
12. trace() 打印信息
13. exit(0) 退出Dtrace
14. printf格式化输出


## 变量
01. 全局(name)、线程本地(self->name)、 探针语句本地{name}
02. 集积 @name 对某个key进行累计
03. 联合数组 int x[unsigned long long, char]; 
04. $1 表示Dtrace 命令的第一个参数 
05. arg0 enter 表示当前函数的第一个参数 return arg1 返回值 
06. errno int 系统调用的当前 errno 值
07. execname string 当前进程的可执行文件的名称 
08. pid pid_t 当前进程的进程 ID 
09. tid id_t 当前线程的线程 ID 
10. probeprov string 当前探测器描述的提供器字段 
11. probemod string 当前探测器描述的模块字段 
12. probefunc string 当前探测器描述的函数字段 
13. probename string 当前探测器描述的名称字段
14. ‘name 访问操作系统的变量 数据结构 类型
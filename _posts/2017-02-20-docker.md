---
layout: post
title:  "Docker on Mac"
date:   2017-02-20 11:17:00
categories: Other
excerpt: Docker on Mac
---

* content
{:toc} 

# 原理
01. ![](../img/docker.jpeg)
02. namespace 六种隔离
    
        #include<sched.h>
        clone(int(*func)(void*),    线程函数
              void *stackbuf,       线程函数的栈buf
              int flags,            下面的6种隔离的位或
              void *arg, ...)       函数参数
        PID	    CLONE_NEW_PID	隔离进程编号
        UTS	    CLONE_NEWUTS	   主机名
        IPC	    CLONE_NEWIPC	   进程通讯相关的，信号量、消息队列、内存映射
        Network  CLONE_NEWNET	   网络协议栈、ARP表、路由表、NAT表
        Mount    CLONE_NEWNS	   文件系统挂载点
        User	    CLONE_NEWUSER	用户、组名

03.  CGroup 资源隔离

        创建或下载镜像文件系统github.com/CentOS/sig-cloud-instance-images
        在clone的线程函数中执行
        在解压目录(root_path)创建proc目录修改权限为0x755
        mount("proc", proc_path, "proc")
        mount("root", root_path, "", MS_BIND|MS_REC)
        在root_path创建.pivot_root目录权限0x700
        pivot_root(root_path， pivot_root_path)
        umoount("/.pivot_root", MNT_DETACH)
        

# 基本命令
- docker --version
- docker-compose --version
- docker-machine --version
- docker pull xxx 下载image xxx
- docker build --no-cache -t xxx:xxx . 创建image
- docker images 显示已有的image
- docker rmi xxx 删除image xxx
- docker run -itd -p host80:80 -h host -v host/path:path --name xx xx:xx
- docker ps 展示目前启动的容器
- docker ps -a 展示所有容器
- docker inspect xx 显示当前容器详细配置
- docker start 启动容器
- docker stop 停止容器
- docker rm -f webservr 停止并删除容器，但不会删除镜像
- docker exec -it xxx /bin/bash 运行容器并进入shell -u root 以root用户
- docker attach xxx 进入运行中的容器
- docker commit xxx xx:xx 将content打包为镜像
- docker export xxx -o xxx.tar 将content转为xxx.tar
- docker save -o xxx.tar xxx:xx 将容器镜像打包
- docker load -i xxx.tar 加载容器镜像 
- cat xxx.tar | docker import - xxx:xx
- /etc/docker/daemon.json "registry-mirrors":["http://hub-mirror.c.163.com"],

## Dockerfile
01. FROM 基础镜像
02. MAINTAINER  作者信息 邮箱要用""
03. USER 指定运行时用户 
03. WORKDIR 指定Dockerfile命令运行目录
04. ADD 将host文件拷贝到容器内
05. RUN 执行命令
06. ENV 设置环境变量,ssh登陆后不起作用,修改/etc/profile添加环境
07. EXPOSE 导出端口
08. CMD 执行命令, 只有最后一行会在每次启动时执行 
09. COPY
10. LABEL
11. STOPSIGNAL
12. VOLUME
13. ENTRYPOINT
14. ARG
15. HEALTHCHECK
16. SHELL

## 生成无历史layerimage
01. 写Dockerfile
02. docker build --no-cache -t xx:temp .
03. docker run -itd --name xx xx:temp
04. docker stop -f xx 
05. docker commit xx xx:xx
06. docker save -o xx_xx.tar xx:xx
07. docker rm -f xx
08. docker rmi xx:xx
09. docker rmi xx:temp   
10. docker load -i xx_xx.tar 
11. rm -rf xx_xx.tar

## centos ssh
01. wget http://mirrors.163.com/.help/CentOS7-Base-163.repo
02. DockerFile
        
        FROM centos:7
        MAINTAINER nomadli "dzym79@qq.com"
        WORKDIR /root
        ADD CentOS7-Base-163.repo /etc/yum.repos.d/
        RUN mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.back
        RUN mv /etc/yum.repos.d/CentOS7-Base-163.repo /etc/yum.repos.d/CentOS7-Base.repo
        RUN yum clean all
        RUN yum makecache
        RUN yum -y update
        RUN yum -y install openssh-server
        RUN yum clean all
        RUN echo "root:nomadli" | chpasswd
        RUN sed -i 's/UsePAM yes/UsePAM no/g' /etc/ssh/sshd_config
        RUN sed -i 's/#PermitRootLogin yes/PermitRootLogin yes/g' /etc/ssh/sshd_config
        RUN sed -i 's/#UsePrivilegeSeparation sandbox/UsePrivilegeSeparation no/g' /etc/ssh/sshd_config
        RUN ssh-keygen -q -t rsa -b 2048 -f /etc/ssh/ssh_host_rsa_key -N ''
        RUN ssh-keygen -q -t ecdsa -f /etc/ssh/ssh_host_ecdsa_key -N ''
        RUN ssh-keygen -t dsa -f /etc/ssh/ssh_host_ed25519_key -N ''
        RUN echo "#!/bin/bash" > /root/init.sh
        RUN echo "/usr/sbin/sshd -f /etc/ssh/sshd_config" >> /root/init.sh
        RUN echo "/bin/bash" >> /root/init.sh
        RUN chmod +x /root/init.sh
        CMD ["/root/init.sh"] 


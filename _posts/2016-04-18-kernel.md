---
layout: post
title:  "kernel"
date:   2016-04-18 10:37:00
categories: Other
excerpt: kernel。
---

* content
{:toc}

## Linux
1. 逻辑地址(段、偏移量、段描述符)->线性地址->物理地址
2. 段选择寄存器:cs代码、ss栈、ds数据、es、fs、gs普通
3. cs 含两位 0内核、3用户、1、2没有用
4. 段描述符(全局、本地)
5. 只有86体系32位使用段，liunx内核段偏移地址等于线性地址

## OS X  IOS 架构图
![1]

## OS X IOS 内核跟踪、调试、基本信息
01. Aqua:launchd-application services-core graphics-windowserver
02. plutil 转换plist、nib格式
03. kevent 内核事件通知 <br><code>int kq = kqueue();<br>
EV_SET(&ke,pid,EVFILT_PROC,EV_ADD,NOTE_EXIT,0,NULL);<br>
int rc = kevent(kq, &ke, 1, NULL, 0, NULL);<br>
rc = kevent(kq, NULL, 0, &ke, 1, NULL)</code><br>
04. audit、auditctl、auditon、getaudit、setaudit、getaudit_addr、setaudit_addr、mach_port_name_t、audit_session_join、audit_session_port 审计OS X only
05. MAC Mandatory Access Control强制访问控制__mac_系列
06. FSEvents 文件系统通知 /dev/fsevents 虚拟设备 open、ioctl设置事件、read、close
07. ios权限白名单plist在二进制文件末尾未加密 cat -tv app_path \| tail -31 \| more
08. TSTOP、TOSTOP、CONT信号、pid_suspend、pid_resume暂停继续进程。pid_shutdown_sockets
09. PE32/PE32+(MZ) window、EFI，ELF(7FELF) linux、unix，脚本(#!),FAT(cafebabe\<l\>、bebafeca\<B\>)，Mach-o(feedface<32>,feedfacf<64>)
10. 富二进制头 [magic,narc][cputype,cpusubtype,offset,size,align]...
11. Mach-o头[magic,cputype,cpusubtype,filetype,ncmds,sizeofcmds,flags,reserved<64>][cmdtype,cmdsize,cmd]... filetype:MH_OBJECT、MH_EXECUTABLE、MH_CORE、MH_DYLIB、MH_BUNDLE、MH_DSYM、MH_KEXT_BUNDLE。flags:MH_NOUNDEFS、MH_SPLITSEGS...。cmdtyp:LC_SEGMENT...
12. LC_SEGMENT(_64) 0x01(0x19) 加载段[LC_SEGMENT(_64),cmdsize,segname,vmaddr,vmsize,fileoff,filesize,maxprot,initprot,nsects,flags][sects]...
13. LC_DYLINKER 动态库符号绑定 用户态 LC_SYMTAB、LC_DSYMTAB、LC_LOAD_DYLIB... 
14. LC_UNIXTHREAD被LC_MAIN代替 启动主线程 加载寄存器 ARM(i386、x86)_THREAD_STATE(64) r15 程序计数器 
15. LC_THREAD 核心转储
16. LC_CODE_SIGNATURE 加载数字签名 如果没有或不匹配立刻SIGKILL信号
17. 函数拦截 \_\_attribute\_\_((used)) static struct{const void* replacement;const void* replacee;}replacestruct  \_\_attribute\_\_((section("__DATA,__interpose")))={(const void\*)(unsigned long)&替换函数,(const void*)(unsigned long)&被替换函数}；
18. void main(int argc, char \*\*argv, char \*\*envp, char \*\*apple)
19. 内存分段 __PAGEZERO 4KB(4G) 取消了所有权限SIGBUS信号;__TEXT 代码段;__LINKEDIT 动态符号表 字符串表 其他数据;__IMPORT i386二进制文件导入表;__DATA 可读可写数据;__MALLOC_TINY 小于一个页面的内存分配;__MALLOC_SMALL 几个页面的内存分配;__MALLOC_LARGE 1M以上的内存分配。
20. commpage 段 固定地址ffff0000(7fffffe00000) arm(40000000)内核导出给用户态的共享只读页面,PPC的遗留在清除.
21. alloca 在栈上分配内存
22. CHUD、AppleProfileFamily、CoreProfile ios没有Dtrace
23. proc_info显示设置进程线程信息
24. stack_snapshot 进程快照
25. kdebug 通过sysctl KERN_KDENABLE启用 内核日志int32压缩
26. setrlimit 设置核心转储大小设置
27. Malloc* 环境变量可以输出内存读写错误的日志
28. libgmalloc.dylib 截获内存分配、调试内存

## OS X 引导过程
01. EFI(Intel Extensible Firmware Interface) PE格式
02. boot.efi EFI加载器 添加了自定义头 区分 32 64
03. EFI_STATUS (EFIAPI *EFI_IMAGE_ENTRY_POINT)(IN EFI_HANDLE handle, IN EFI_SYSTEM_TABLE table) main函数
04. 调用ExitBootServices()前是引导服务，提供内存、硬件访问、EFI程序调用，引导服务保存在EFI_SYSTEM_TABLE结构中。
05. 运行时服务在引导和操作系统模式都可以访问
06. boot.efi 保存EFI_SYSTEM_TABLE到全局变量,cpuid汇编指令查看cpu是否支持AES-NI指令(AES加密解密加速),初始化控制台{调用RunTimeServices查询NVRAM变量Background Clear,调用LocateProtocol控制台,GetMode获取控制台模式},获取NVRM中ROM和MLB变量,初始化设备树,为内核分配内存,保存内核地址到全局变量,InitMemoryConfig,InitSupportedCPUTypes,检查休眠状态CheckHibernate如果是休眠跳过下面所有步骤,处理引导按键和com.apple.Boot.plist配置ProcessOptions,cupid汇编判断cpu是否支持64位,检查CoreStorage如果有CoreStorage获取分区ID、EFI句柄调用LoadCoreStorageConfiguration获取CoreStorage参数如果是加密卷调用UnlockCoreStorageVolumeKey,将控制台初始化为图形模式,绘制logo,加载内核LoadKernel,初始化内核参数BootStructå,加载设备驱动Extensions.mkext,如果指定RAMDisk将其加载到内存,结束logo动画,再次设置其他内核参数,调用ExitBootServices,跳转到内核
07. 睡眠返回时调用EFI运行时hibernate_newruntime_map
08. Boot Camp功能使EFI可以引导多系统其中提供了完整的驱动程序  

## IOS 引导过程
01. 不支持EFI使用iBoot,除第一步引导ROM后续步骤都是加密且签名,ROM是固化不能升级的
02. 普通引导 加载底层引导加载器LLB(IMG3)到预定义地址(84000000),加载iBoot如果失败进入DFU模式,加载iBoot引导加载器到5FF000000,调用fsboot挂载系统分区,定位内核,初始化设备树,引导系统,引导失败进入恢复模式。iBoot有main线程和串口调试线程,mian派生idleoff(自动锁屏)、poweroff(电量低关机)、usb-req(usb请求)、usb-high-current usb-no-current(充电).恢复模式使用ramdisk(内存文件系统)替换根文件系统。
03. 更新模式(DFU) 加载底层初始化模块iBS(84000000),加载iBEC(85000000)处理USB命令

## OS X 安装过程
01. 向osrecovery.apple.com验证
02. 将kernelcache、boot.efi、InstallESD.dmg复制到/Mac OS X Install Data目录
03. 修改com.apple.Boot.plist Kernel Cache=\*/kernelcache Kernel Flags = container-dmg=\*/InstallESD.dmg rootdmg=System.dmg(根文件系统)
04. bless 修改引导盘从InstallESD.dmg引导
05. 重启后执行OSInstaller加载minstallconfig.xml安装配置、安装系统

## IOS 安装过程
01. .ipsw其实是zip文件     

[1]: /img/osx_ios_kernel.png
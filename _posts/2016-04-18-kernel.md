---
layout: post
title:  "kernel"
date:   2016-04-18 10:37:00
categories: Other
excerpt: kernel。
---

* content
{:toc}

## Linux
1. 逻辑地址(段、偏移量、段描述符)->线性地址->物理地址
2. 段选择寄存器:cs代码、ss栈、ds数据、es、fs、gs普通
3. cs 含两位 0内核、3用户、1、2没有用
4. 段描述符(全局、本地)
5. 只有86体系32位使用段，liunx内核段偏移地址等于线性地址

## OS X  IOS 架构图
![1]

## OS X IOS 内核跟踪、调试、基本信息
01. Aqua:launchd-application services-core graphics-windowserver
02. plutil 转换plist、nib格式
03. kevent 内核事件通知 <br><code>int kq = kqueue();
EV_SET(&ke,pid,EVFILT_PROC,EV_ADD,NOTE_EXIT,0,NULL);
int rc = kevent(kq, &ke, 1, NULL, 0, NULL);
rc = kevent(kq, NULL, 0, &ke, 1, NULL)</code><br>
04. audit、auditctl、auditon、getaudit、setaudit、getaudit_addr、setaudit_addr、mach_port_name_t、audit_session_join、audit_session_port 审计OS X only
05. MAC Mandatory Access Control强制访问控制__mac_系列
06. FSEvents 文件系统通知 /dev/fsevents 虚拟设备 open、ioctl设置事件、read、close
07. ios权限白名单plist在二进制文件末尾未加密 cat -tv app_path | tail -31 | more 
08. TSTOP、TOSTOP、CONT信号、pid_suspend、pid_resume暂停继续进程。pid_shutdown_sockets
09. PE32/PE32+(MZ) window、EFI，ELF(7FELF) linux、unix，脚本(#!),FAT(cafebabe<l>、bebafeca<B>)，Mach-o(feedface<32>,feedfacf<64>)
10. 富二进制头 [magic,narc][cputype,cpusubtype,offset,size,align]...
11. Mach-o头[magic,cputype,cpusubtype,filetype,ncmds,sizeofcmds,flags,reserved<64>][cmdtype,cmdsize,cmd]... filetype:MH_OBJECT、MH_EXECUTABLE、MH_CORE、MH_DYLIB、MH_BUNDLE、MH_DSYM、MH_KEXT_BUNDLE。flags:MH_NOUNDEFS、MH_SPLITSEGS...。cmdtyp:LC_SEGMENT...
12. LC_SEGMENT(_64) 0x01(0x19) 加载段[LC_SEGMENT(_64),cmdsize,segname,vmaddr,vmsize,fileoff,filesize,maxprot,initprot,nsects,flags][sects]...
13. LC_DYLINKER 动态库符号绑定 用户态 LC_SYMTAB、LC_DSYMTAB、LC_LOAD_DYLIB... 
14. LC_UNIXTHREAD被LC_MAIN代替 启动主线程 加载寄存器 ARM(i386、x86)_THREAD_STATE(64) r15 程序计数器 
15. LC_THREAD 核心转储
16. LC_CODE_SIGNATURE 加载数字签名 如果没有或不匹配立刻SIGKILL信号
17. 函数拦截 __attribute__((used)) static struct{const void* replacement;const void* replacee;}replacestruct  __attribute__((section("__DATA,__interpose")))={(const void*)(unsigned long)&替换函数,(const void*)(unsigned long)&被替换函数}；
18. void main(int argc, char **argv, char **envp, char **apple)
19. 内存分段 __PAGEZERO 4KB(4G) 取消了所有权限SIGBUS信号;__TEXT 代码段;__LINKEDIT 动态符号表 字符串表 其他数据;__IMPORT i386二进制文件导入表;__DATA 可读可写数据;__MALLOC_TINY 小于一个页面的内存分配;__MALLOC_SMALL 几个页面的内存分配;__MALLOC_LARGE 1M以上的内存分配。
20. commpage 段 固定地址ffff0000(7fffffe00000) arm(40000000)内核导出给用户态的共享只读页面,PPC的遗留在清除.
21. alloca 在栈上分配内存
22. CHUD、AppleProfileFamily、CoreProfile ios没有Dtrace
23. proc_info显示设置进程线程信息
24. stack_snapshot 进程快照
25. kdebug 通过sysctl KERN_KDENABLE启用 内核日志int32压缩
26. setrlimit 设置核心转储大小设置
27. Malloc* 环境变量可以输出内存读写错误的日志
28. libgmalloc.dylib 截获内存分配、调试内存

## OS X & IOS 引导过程

[1]: /img/osx_ios_kernel.png